# This uses OIDC Trusted Publishing: https://docs.npmjs.com/trusted-publishers
name: Publish package on npm

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18.17.0
      - run: npm ci
      - run: npm run format:check
      - run: npm run build
      - run: npm run test

  check-package-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get package version from NPM registry
        id: npm_version
        run: |
          VERSION=$(npm view @stellarwp/tyson version)
          echo "::set-output name=version::$VERSION"

      - name: Get package version in package.json
        id: package_version
        run: |
          cat ./package.json | jq .version
          echo "::set-output name=version::$(cat ./package.json | jq .version)"

      - name: Compare versions
        shell: bash
        run: |
          if [ "${{ steps.package_version.outputs.version }}" = "${{ steps.npm_version.outputs.version }}" ]; then
            echo "Package version is not greater than NPM registry version."
            exit 1
          else
            echo "Package version is greater than NPM registry version."
          fi

  publish-npm:
    needs: [build, check-package-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # We need to use npm for trusted publishing.
      - name: Set up node
        uses: actions/setup-node@v4
        with:
          node-version: 18.17.0
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci

      # npm >=11.5.1 automatically supports OIDC trusted publishing.
      - name: Publish package to NPM
        run: npm publish --verbose --access public
